pipeline {
    agent any // This will run on any available agent, including Windows

    stages {
        stage('Checkout') {
            steps {
                // The git step is cross-platform and does not need to be changed
                git branch: 'main', url: 'https://github.com/sarthak20052005/simple_webapp.git'
            }
        }

        stage('Setup Python Environment with PowerShell') {
            steps {
                // Use the 'powershell' step for Windows PowerShell commands
                powershell '''
                Write-Host "Setting up Python virtual environment with PowerShell..."

                # Create the virtual environment (assuming python is in your PATH)
                python -m venv venv

                # Activate the virtual environment using the PowerShell script
                # Note the different activation script and syntax
                . .\\venv\\Scripts\\Activate.ps1

                # Verify versions
                python --version
                pip --version
                '''
            }
        }

        stage('Run Tests with PowerShell') {
            steps {
                powershell '''
                Write-Host "Running tests with PowerShell..."
                
                # Activate the environment again for this new PowerShell session
                . .\\venv\\Scripts\\Activate.ps1

                # Use try/catch for more robust error handling in PowerShell
                try {
                    python -m pytest tests/
                }
                catch {
                    Write-Host "Tests Failed"
                    # Exit with a non-zero code to fail the pipeline stage
                    exit 1
                }
                '''
            }
        }
    }
}